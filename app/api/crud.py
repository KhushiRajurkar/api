"""CRUD functions called by path operations."""
import os

import httpx
from fastapi import HTTPException

from . import utility as util


async def get(sex: str):
    """
    Makes a POST request to Stardog API using httpx where the payload is a SPARQL query generated by the create_query function.

    Parameters
    ----------
    sex : str
        Subjects' sex.

    Returns
    -------
    httpx.response
        Response of the POST request.

    """
    response = httpx.post(
        url=util.QUERY_URL,
        content=util.create_query(sex=sex),
        headers=util.QUERY_HEADER,
        auth=httpx.BasicAuth(
            os.environ.get("USER"), os.environ.get("PASSWORD")
        ),
    )

    if response.status_code == 401:
        raise HTTPException(
            status_code=response.status_code, detail="Unauthorized request"
        )

    results = response.json()

    return [
        {k: v["value"] for k, v in res.items()}
        for res in results["results"]["bindings"]
    ]
